<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jens von Bergmann">
<meta name="author" content="Nathan Lauster">
<meta name="dcterms.date" content="2024-04-11">
<meta name="description" content="We estimate that planning decisions preventing apartment buildings built in the past 5 years in Metro Vancouver from being on average 20% taller are resulting in an annual redistribution of income from renters to existing landlords on the order of half a billion dollars across the region via higher rents.">

<title>Mountain Doodles - What if recent apartment buildings in Vancouver were 20% taller?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-54516567-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Mountain Doodles - What if recent apartment buildings in Vancouver were 20% taller?">
<meta property="og:description" content="We estimate that planning decisions preventing apartment buildings built in the past 5 years in Metro Vancouver from being on average 20% taller are resulting in an annual redistribution of income from renters to existing landlords on the order of half a billion dollars across the region via higher rents.">
<meta property="og:image" content="https://doodletest.netlify.app/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller/images/larch56v.png">
<meta property="og:site_name" content="Mountain Doodles">
<meta property="og:image:height" content="1676">
<meta property="og:image:width" content="1474">
<meta name="twitter:title" content="Mountain Doodles - What if recent apartment buildings in Vancouver were 20% taller?">
<meta name="twitter:description" content="We estimate that planning decisions preventing apartment buildings built in the past 5 years in Metro Vancouver from being on average 20% taller are resulting in an annual redistribution of income from renters to existing landlords on the order of half a billion dollars across the region via higher rents.">
<meta name="twitter:image" content="https://doodletest.netlify.app/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller/images/larch56v.png">
<meta name="twitter:creator" content="@vb_jens">
<meta name="twitter:image-height" content="1676">
<meta name="twitter:image-width" content="1474">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../mm_stamp_small.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mountain Doodles</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mountainMath/mountaindoodles"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link active" href="https://twitter.com/vb_jens" aria-current="page"> <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/vb-jens/"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:jens.mountainmath.ca"> <i class="bi bi-envelope-at-fill" role="img" aria-label="Email">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img" aria-label="RSS">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">What if recent apartment buildings in Vancouver were 20% taller?</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">What if recent apartment buildings in Vancouver were 20% taller?</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source" data-quarto-source-url="https://github.com/mountainMath/mountaindoodles/blob/main/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller/index.markdown"><i class="bi"></i></button></div></div>
                  <div>
        <div class="description">
          We estimate that planning decisions preventing apartment buildings built in the past 5 years in Metro Vancouver from being on average 20% taller are resulting in an annual redistribution of income from renters to existing landlords on the order of half a billion dollars across the region via higher rents.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">affordability</div>
                <div class="quarto-category">Vancouver</div>
                <div class="quarto-category">cmhc</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Jens von Bergmann </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              MountainMath
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author">Nathan Lauster </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              UBC, Department of Sociology
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 11, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="quarto-sidebar-header"><div class="sidebar-header-item">
<p><strong>Too much data, too little time</strong></p>
</div></div>
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../profile.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/mountainMath" title="" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/vb_jens" title="" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/in/vb-jens/" title="" class="quarto-navigation-tool px-1" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
    <a href="mailto:jens.mountainmath.ca" title="" class="quarto-navigation-tool px-1" aria-label="Email"><i class="bi bi-envelope-at-fill"></i></a>
</div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Other Canadian data focused blogs:</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://homefreesociology.com" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HomeFreeSociology</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://www.dshkol.com" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dmitry Shkolnik’s blog</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://www.simoncoulombe.com" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simon Coulombe’s blog</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://financesofthenation.ca/category/commentary/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Finances of the Nation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://deny.substack.com" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deny’s Substack</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://higheredstrategy.com/author/alex/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Alex Usher’s blog</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
<div class="quarto-sidebar-footer"><div class="sidebar-footer-item">
<p>Mountain Doodles is an insomnia driven side project, born out of random questions, trying to give partial answers through data. During daytime at <a href="https://mountainmath.ca">MountainMath</a>.</p>
</div></div></nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p style="text-align:center;">
<i>(Joint with Nathan Lauster and cross-posted at <a href="https://homefreesociology.com/2024/04/11/what-if-recent-apartment-buildings-in-vancouver-were-20-taller/" target="_blank">HomeFreeSociology</a>)</i>
</p>
<p>Earlier this year a <a href="https://www.productivity.nsw.gov.au/sites/default/files/2024-02/What-we-gain-by-building-more-homes-in-the-right-places.pdf#page=10">report from the NSW Productivity Commission</a> in New South Wales, Australia, included a useful estimate to illustrate the harm that’s being done by height restrictions in Sydney. We thought it might be helpful to replicate the analysis for the Vancouver context.</p>
<p>Taking ideas from the report we set up a simple counter-factual question:</p>
<p><strong>What would rents be if every apartment building built in Metro Vancouver over the past five years had been on average 20% taller?</strong></p>
<section id="tldr" class="level1">
<h1>TL;DR</h1>
<p>We estimate that planning decisions preventing apartment buildings built in the past 5 years in Metro Vancouver from being on average 20% taller are resulting in an annual redistribution of income from renters to existing landlords on the order of half a billion dollars across the region via higher rents.</p>
</section>
<section id="economics-101" class="level1">
<h1>Economics 101</h1>
<p>To answer our counter-factual question, it’s worth quickly reviewing some basic economics concept. Firstly, the demand curve for housing slopes down. That means that as the price or rent for housing falls, more people will look to buy or rent that housing. That generally leads more households to form, e.g.&nbsp;young adults moving out of their parent’s basement or out of roommate or other complex household situations to form their own households. And it could mean some people that would have otherwise been pushed out are now able to stay, and some people deterred by high housing costs can move into our region. And the reverse of all that will happen if housing prices and rents rise.</p>
<p>How do we know this? Economic theory tells us demand curves generally slope downward and <a href="https://doodles.mountainmath.ca/blog/2023/08/17/housing-outcomes/">both theory and data confirm the demographic implications</a>. But to answer our question we need to quantify this more precisely. If we increase our housing stock by some percentage, by what percentage will prices and rents change? This is the (inverse) price elasticity of demand. It is the (inverse of the) slope to the demand curve, shown in black in the plot below, re-expressed in terms of the percentage change of demand and supply.</p>
<p><img src="index_files/figure-html/supply-demand-1.png" width="768"></p>
<p>These type of elasticities are notoriously difficult to identify. We are interested in the “long run” effect, so effects after markets adjust to short-term supply shocks. The report we cite above uses an estimate of -0.4 for Sydney, and estimates <a href="https://www.cmhc-schl.gc.ca/media-newsroom/news-releases/2023/update-canada-housing-supply-shortages">done by CMHC for the whole province of British Columbia</a> suggest a similar value of around -0.5. We have <a href="https://news.gov.bc.ca/files/bc_SSMUH_TOA_scenarios_Final.pdf">previously estimated the price elasticity of demand for Metro Vancouver to be around -0.25</a>, albeit with large confidence intervals. For this analysis we will use the value of -0.4 which is closer to what the <a href="https://www.jstor.org/stable/j.ctv13gvj30">broader literature suggests</a>, with the understanding that this estimate comes with uncertainties and actual effects might be a bit larger or a bit smaller. For reference, an estimate of -0.4 is equivalent to calculating that a 1% increase in supply would result in a 2.5% decrease in prices and rents. Since ours is a point estimate of price elasticity, these effects compound, and a 10% increase in supply would result in a 21% decrease in prices and rents.</p>
<p>We note that the supply curve in the graph above is to be taken with a grain of salt. While the demand curve for housing works roughly as one would expect, insofar as housing is largely allocated via market mechanisms, the supply of housing works differently. To list just two caveats, housing is a durable good, with the market largely composed of existing, rather than newly produced, housing. More importantly for our purposes, there are strong external constraints on how much new supply can be added through newly produced housing. Even where supply curves suggest developers would happily add more dwellings in response to prices, planning often prevents them from doing so.</p>
</section>
<section id="height-restrictions-in-vancouver" class="level1">
<h1>Height restrictions in Vancouver</h1>
<p>For this post height limitation plays the role of a simple proxy for the restrictiveness of zoning. A <a href="https://eppdscrmssa01.blob.core.windows.net/cmhcprodcontainer/sf/project/archive/research_5/rr_supply_constraints_increased_prices_mar_12.pdf">CMHC report from 2019</a> has found that height restrictions are strongly binding in Vancouver, meaning a developer would be very likely to build taller if they were allowed to do so.</p>
<p>The effect of zoning restrictions is generally difficult to observe when only looking at development proposals that make it into the city approval process, but we can still see some of the effect of height restrictions play out there.</p>
<p>For example the development at 1535-1557 Grant Street was initially <a href="https://www.vancouverisawesome.com/courier-archive/real-estate/six-storey-rental-building-proposed-to-replace-four-century-old-grandview-woodland-houses-3082956">proposed as a 6 storey apartment building</a> as in principle enabled under the Grandview-Woodland community plan, but was subsequently <a href="https://council.vancouver.ca/20190723/documents/p10.pdf">cut down to 5 storeys</a> in “direct response” to Urban Design Panel &amp; staff review.</p>
<p>The project at 1805 Larch brought forward under the Moderate Income Rental Housing Pilot Project went from <a href="https://cityduo.wordpress.com/2019/09/06/a-look-behind-the-curtains-of-city-hall-the-challenges-and-prejudices-renters-face-in-kitsilano/">six to five due to opposition at the pre-application open house</a> and <a href="https://twitter.com/pwaldkirch/status/1116142005396967424">was compelled to provide more parking spaces</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/larch56h.png" class="img-fluid figure-img"></p>
<figcaption>Original 6 storey version</figcaption>
</figure>
</div>
<p>The development around <a href="https://council.vancouver.ca/20190514/documents/p4.pdf">708 Renfrew Street</a> proposed under the Affordable Housing Choices (AHC) Policy did not see a reduction in the nominal number of storeys, but saw significant massing changes with the original proposal 43% times larger than the version that eventually got approved. However, the reduction in housing units seems to have ultimately <a href="https://twitter.com/rwittstock/status/1324465414949105664">proven fatal</a> to the project’s viability, and the developer abandoned the project.</p>
<p>This motivates our counter-factual of trying to understand what would have happened if recently constructed apartment buildings were on average 20% taller, and had (roughly) 20% more units.</p>
</section>
<section id="apartment-construction" class="level1">
<h1>Apartment construction</h1>
<p>To estimate the impact we look at historical apartment construction in Metro Vancouver, and hypothetically add 20% more units for the past 5 years. This is a rough estimate of what taller buildings could provide, of course. The math linking unit numbers to heights can be more complicated. Taller buildings might’ve enabled more projects (like 708 Renfrew) to “pencil” potentially adding even more units than our estimate. On the other hand, <a href="https://doodles.mountainmath.ca/blog/2022/06/12/ins-and-outs-of-cmhc-data/">CMHC also counts secondary suites as “apartment units”</a>, which could lead to us overestimating, but that likely only causes a small distortion in the stats.</p>
<p><img src="index_files/figure-html/completions-with-counterfactual-1.png" width="768"></p>
<p>Overall, there were 81,317 apartment completions in the past 5 years. Had the buildings containing these apartments been on average 20% taller there would have been 16,263 additional housing units, resulting in an 1.5% increase in total housing stock in Metro Vancouver. Using our common demand elasticity assumption, that additional housing supply would have led to a reduction of prices and rents by 3.7%.</p>
</section>
<section id="impact-on-rents" class="level1">
<h1>Impact on rents</h1>
<p>To make this a little more concrete, we can use the average rent for 2-bedroom units in Metro Vancouver with a new rental contract in the preceding year as a proxy for the average rent in the region and estimate the counter-factual rents.</p>
<p>CMHC is <a href="https://www.cmhc-schl.gc.ca/professionals/housing-markets-data-and-research/housing-data/data-tables/rental-market/rental-market-report-data-tables">now collecting information of rents of units with new rental contracts</a>, and the average such 2-bedroom unit in Metro Vancouver rented for $2,601 a month in 2023. If apartment buildings built during the past 5 years had been on average 20% taller, then the average rent would have been $93 a month lower, saving the average new renter about $1,120 a year. For comparison, BC’s new <a href="https://www2.gov.bc.ca/gov/content/taxes/income-taxes/personal/credits/renters-tax-credit">Renter’s Tax Credit</a> maxes out at $400 per year.</p>
<p>Rents for long-time tenants tend to be lower than for new tenants under BC’s rent control, reflecting Metro Vancouver’s lengthy history of low vacancy rates driving rents for new contracts ever higher. Correspondingly, for tenants under existing rent-controlled tenancy agreements the benefits of adding supply are less direct than for new tenants. Long-time tenants primarily experience additional supply effects in terms of increased choice and lower rents if they are looking to change their living arrangements because of a lower overall <a href="https://doodles.mountainmath.ca/blog/2018/11/28/moving-penalty/">moving penalty</a>. But they also potentially gain in their landlords becoming a little less <a href="https://homefreesociology.com/2021/03/29/forced-out-in-canada-new-data-from-chs/">keen to encourage turnover</a>.</p>
<p>At this point it is useful to point out that the aggregate effect of the added counter-factual housing is a net transfer of wealth from existing landlords to tenants. Rent control delays some of these effects, but scaling the rent saving over the existing renter households in Metro Vancouver yields a net transfer of $442M a year from existing landlords to tenants in terms of aggregate rent savings.</p>
</section>
<section id="impact-on-broader-housing-outcomes" class="level1">
<h1>Impact on broader housing outcomes</h1>
<p>On top of that, the increase in housing stock will allow existing households to who are unhappy with their current living arrangements, for <a href="https://doodles.mountainmath.ca/blog/2023/08/17/housing-outcomes/">example adults living with parents, or roommates, or other complex living arrangements</a>, to move into their own units. Toronto and Vancouver have elevated rates of such young adults not in <a href="https://doodles.mountainmath.ca/blog/2023/08/17/housing-outcomes/">“Minimal Household units”</a>, and new housing units are needed for these young adults to form their own households.</p>
<p><img src="../../posts/2023-08-17-housing-outcomes/index_files/figure-html/non_mhu_type-1.png" class="img-fluid"></p>
<p>This under-appreciated benefit of increasing the housing stock allows individuals and families to better match their housing to their needs and preferences.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>One might be inclined to think that a reduction of average rents from $2,601 to $2,508 a month is quite small. And we agree and believe that our counter-factual increase in new housing by 20% is very modest. We should aim for a much larger increase in housing. Previous <a href="https://doodles.mountainmath.ca/blog/2023/06/27/housing-targets/">analysis we performed</a> suggests developers would have built enough units to increase our housing stock by 250,000 units, or 23% if municipalities had let them. This would have resulted in a reduction of average rents by 40%, thus bringing Vancouver rents in line with Canada-wide average CMA rent and resulting in enormous benefits to renters.</p>
<p>Our counter-factuals are purely hypothetical in the sense that we cannot turn back time and allow apartments that have already been built to be taller. But they illustrate the the benefits of building more housing, and the harm of restricting the amount of housing getting built.</p>
<p>We suspect that many municipal planners and politicians don’t understand the extent of the harm to renters or new buyers they are causing by reducing the height of buildings, or more generally by restricting the supply of housing. Planning documents where planners give reasons for significantly reducing height and form of proposed buildings, <a href="https://vancouver.ca/files/cov/2018-527-release3.pdf">like the one for the MIRHPP at Larch and 3rd</a>, are often justified largely on aesthetic grounds (“Substantial massing change is required to provide a compatible form of development […] in relation to the surrounding RT-8 and RM-4 developments”) and do not seem to fully weigh or even consider the tradeoffs of the effects on rents and broader housing outcomes, even in cases like this that contain dedicated below-market units.</p>
<p>The other takeaway from this analysis is that affordability comes from supply effects. In terms of affordability, the purpose of new housing is to make old housing cheaper. Often we hear people ask that new housing be affordable, or that new housing should be targeted at specific income groups. This is entirely appropriate and important when it comes to dedicated non-market housing. But trying to target new market housing at specific income bands fundamentally misunderstands housing, and is likely counter-productive. Or in the <a href="https://www.lewis.ucla.edu/research/value-capture-reconsidered/">words of Michael Manville</a>:</p>
<blockquote class="blockquote">
<p>If we believe that cheap housing matters and expensive housing doesn’t, and we act on that belief, our primary accomplishment will be to make our cheap housing expensive.</p>
</blockquote>
<p>And not coincidentally we have been doing a bang-on job at making our cheap housing expensive across Metro Vancouver.</p>
<p>As usual, the code for this post is <a href="https://github.com/mountainMath/doodles/blob/master/content/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller/index.Rmarkdown">available on GitHub</a> for anyone to reproduce or adapt for their own purposes.</p>
<details>
<summary>
Reproducibility receipt
</summary>
<pre><code>## [1] "2024-04-11 13:56:07 PDT"</code></pre>
<pre><code>## Local:    master /Users/jens/R/mountaindoodles
## Remote:   master @ origin (https://github.com/mountainMath/doodles.git)
## Head:     [0ec8ecd] 2024-01-17: fix latex snafu</code></pre>
<pre><code>## R version 4.3.2 (2023-10-31)
## Platform: aarch64-apple-darwin20 (64-bit)
## Running under: macOS Sonoma 14.4.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## time zone: America/Vancouver
## tzcode source: internal
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] mountainmathHelpers_0.1.4 cmhc_0.2.8               
##  [3] cancensus_0.5.8           lubridate_1.9.3          
##  [5] forcats_1.0.0             stringr_1.5.1            
##  [7] dplyr_1.1.4               purrr_1.0.2              
##  [9] readr_2.1.4               tidyr_1.3.0              
## [11] tibble_3.2.1              ggplot2_3.5.0            
## [13] tidyverse_2.0.0          
## 
## loaded via a namespace (and not attached):
##  [1] gtable_0.3.4       xfun_0.41          bslib_0.6.1        htmlwidgets_1.6.4 
##  [5] tzdb_0.4.0         vctrs_0.6.5        tools_4.3.2        generics_0.1.3    
##  [9] parallel_4.3.2     curl_5.2.0         fansi_1.0.6        highr_0.10        
## [13] cluster_2.1.4      pkgconfig_2.0.3    data.table_1.14.10 checkmate_2.3.1   
## [17] lifecycle_1.0.4    git2r_0.33.0       compiler_4.3.2     farver_2.1.1      
## [21] munsell_0.5.0      htmltools_0.5.7    sass_0.4.8         yaml_2.3.7        
## [25] htmlTable_2.4.2    Formula_1.2-5      crayon_1.5.2       pillar_1.9.0      
## [29] jquerylib_0.1.4    cachem_1.0.8       Hmisc_5.1-1        rpart_4.1.21      
## [33] tidyselect_1.2.0   digest_0.6.33      stringi_1.8.3      bookdown_0.37     
## [37] labeling_0.4.3     rprojroot_2.0.4    fastmap_1.1.1      grid_4.3.2        
## [41] here_1.0.1         colorspace_2.1-0   cli_3.6.2          magrittr_2.0.3    
## [45] base64enc_0.1-3    utf8_1.2.4         foreign_0.8-85     withr_2.5.2       
## [49] scales_1.3.0       backports_1.4.1    bit64_4.0.5        timechange_0.2.0  
## [53] httr_1.4.7         rmarkdown_2.25     bit_4.0.5          nnet_7.3-19       
## [57] gridExtra_2.3      blogdown_1.19      sanzo_0.1.0        hms_1.1.3         
## [61] evaluate_0.23      knitr_1.45         rlang_1.1.3        glue_1.7.0        
## [65] vroom_1.6.5        rstudioapi_0.15.0  jsonlite_1.8.8     R6_2.5.1</code></pre>
</details>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@misc{von bergmann2024,
  author = {von Bergmann, Jens and Lauster, Nathan},
  title = {What If Recent Apartment Buildings in {Vancouver} Were 20\%
    Taller?},
  date = {2024-04-11},
  url = {https://doodletest.netlify.app/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-von bergmann2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Bergmann, Jens von, and Nathan Lauster. 2024. <span>“What If Recent
Apartment Buildings in Vancouver Were 20% Taller?”</span>
<em>MountanDoodles</em> (blog). April 11, 2024. <a href="https://doodletest.netlify.app/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller">https://doodletest.netlify.app/posts/2024-04-11-what-if-recent-apartment-buildings-in-vancouver-were-20-taller</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/doodletest\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>